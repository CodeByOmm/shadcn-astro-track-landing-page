---
import { SITE_METADATA, SITE_URL } from '@/consts'
import fs from 'fs'
import path from 'path'

interface Props {
  title?: string
  description?: string
  image?: string
  type?: 'website' | 'article'
  keywords?: string
  author?: string
  publishedTime?: string
  modifiedTime?: string
  noindex?: boolean
  nofollow?: boolean
  schema?: Record<string, any>
}

// Check if this is a production deployment by checking if the production flag exists
let isProductionDeploy = false
try {
  const envFlagPath = path.join(process.cwd(), 'src', '.production-env')
  isProductionDeploy = fs.existsSync(envFlagPath)
} catch (e) {
  // If we can't check the file system, fall back to environment variables
  isProductionDeploy = import.meta.env.VERCEL || import.meta.env.NETLIFY || import.meta.env.NODE_ENV === 'production'
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site)
const {
  title,
  description,
  image,
  type = 'website',
  keywords,
  author,
  publishedTime,
  modifiedTime,
  noindex = false,
  nofollow = false,
  schema
} = Astro.props

// Use site metadata defaults if not provided
const finalTitle = title ? `${title} | ${SITE_METADATA.title.default}` : SITE_METADATA.title.default
const finalDescription = description || SITE_METADATA.description
const finalKeywords = keywords || SITE_METADATA.keywords.join(', ')
const finalImage = image || SITE_METADATA.openGraph.images[0].url
const imageURL = new URL(finalImage, Astro.site)
const finalAuthor = author || SITE_METADATA.authors[0].name

// Auto-set noindex/nofollow for production deployments (demo/staging sites)
const forceNoIndex = isProductionDeploy
const forceNoFollow = isProductionDeploy

// Robots meta tag with production override
const shouldNoIndex = noindex || forceNoIndex || !SITE_METADATA.robots.index
const shouldNoFollow = nofollow || forceNoFollow || !SITE_METADATA.robots.follow
const robotsContent = `${shouldNoIndex ? 'noindex' : 'index'}, ${shouldNoFollow ? 'nofollow' : 'follow'}, max-image-preview:large, max-snippet:-1, max-video-preview:-1`

// Default schema.org structured data
const defaultSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: SITE_METADATA.openGraph.siteName,
  url: Astro.site?.toString(),
  description: finalDescription,
  inLanguage: SITE_METADATA.language.split('-')[0],
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `${Astro.site}search?q={search_term_string}`
    },
    'query-input': 'required name=search_term_string'
  }
}

const schemaData = schema || defaultSchema
---

<!-- Essential Meta Tags -->
<meta charset='utf-8' />
<meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover' />
<meta name='generator' content={Astro.generator} />
<meta http-equiv='X-UA-Compatible' content='IE=edge' />

<!-- Primary Meta Tags -->
<title>{finalTitle}</title>
<meta name='title' content={finalTitle} />
<meta name='description' content={finalDescription} />
<meta name='keywords' content={finalKeywords} />
<meta name='author' content={finalAuthor} />
<meta name='creator' content={SITE_METADATA.creator} />
<meta name='publisher' content={SITE_METADATA.publisher} />

<!-- Canonical URL -->
<link rel='canonical' href={canonicalURL} />

<!-- Robots Meta Tags -->
<meta name='robots' content={robotsContent} />
<meta name='googlebot' content={robotsContent} />
<meta name='bingbot' content={robotsContent} />

<!-- Sitemap -->
<link rel='sitemap' href='/sitemap-index.xml' />

<!-- Verification (if provided) -->
{
  SITE_METADATA.verification.google && (
    <meta name='google-site-verification' content={SITE_METADATA.verification.google} />
  )
}
{SITE_METADATA.verification.bing && <meta name='msvalidate.01' content={SITE_METADATA.verification.bing} />}
{SITE_METADATA.verification.yandex && <meta name='yandex-verification' content={SITE_METADATA.verification.yandex} />}

<!-- Language and Locale -->
<meta property='og:locale' content={SITE_METADATA.locale} />
<meta http-equiv='content-language' content={SITE_METADATA.language} />

<!-- Favicon and Icons -->
{SITE_METADATA.icons.icon.map(icon => <link rel='icon' type={icon.type} sizes={icon.sizes} href={icon.url} />)}
{SITE_METADATA.icons.apple.map(icon => <link rel='apple-touch-icon' sizes={icon.sizes} href={icon.url} />)}
{SITE_METADATA.icons.shortcut.map(icon => <link rel='shortcut icon' href={icon.url} />)}
<link rel='manifest' href='/site.webmanifest' />

<!-- Sitemap -->
<link rel='sitemap' href='/sitemap.xml' />

<!-- RSS Feed -->
<link
  rel='alternate'
  type='application/rss+xml'
  title={`${SITE_METADATA.title.default} RSS Feed`}
  href={new URL('rss.xml', Astro.site)}
/>

<!-- Open Graph / Facebook -->
<meta property='og:type' content={type} />
<meta property='og:url' content={canonicalURL} />
<meta property='og:site_name' content={SITE_METADATA.openGraph.siteName} />
<meta property='og:title' content={title || SITE_METADATA.openGraph.title} />
<meta property='og:description' content={finalDescription} />
<meta property='og:image' content={imageURL} />
<meta property='og:image:url' content={imageURL} />
<meta property='og:image:secure_url' content={imageURL} />
<meta property='og:image:width' content={SITE_METADATA.openGraph.images[0].width.toString()} />
<meta property='og:image:height' content={SITE_METADATA.openGraph.images[0].height.toString()} />
<meta property='og:image:alt' content={title || SITE_METADATA.openGraph.images[0].alt} />
<meta property='og:image:type' content={SITE_METADATA.openGraph.images[0].type} />
{publishedTime && <meta property='article:published_time' content={publishedTime} />}
{modifiedTime && <meta property='article:modified_time' content={modifiedTime} />}
{author && <meta property='article:author' content={author} />}

<!-- Twitter -->
<meta name='twitter:card' content={SITE_METADATA.twitter.card} />
<meta name='twitter:site' content={SITE_METADATA.twitter.site} />
<meta name='twitter:creator' content={SITE_METADATA.twitter.creator} />
<meta name='twitter:title' content={title || SITE_METADATA.twitter.title} />
<meta name='twitter:description' content={finalDescription} />
<meta name='twitter:image' content={imageURL} />
<meta name='twitter:image:alt' content={title || SITE_METADATA.openGraph.images[0].alt} />
<meta property='twitter:url' content={canonicalURL} />

<!-- Performance and Resource Hints -->
<link rel='dns-prefetch' href='https://fonts.googleapis.com' />
<link rel='preconnect' href='https://fonts.googleapis.com' />
<link rel='preconnect' href='https://fonts.gstatic.com' crossorigin='anonymous' />
<link
  href='https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Fira+Code:wght@300..700&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400..700;1,400..700&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Outfit:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&family=Space+Grotesk:wght@300..700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&family=Noto+Serif+Georgian:wght@100..900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&Orbitron:wght@400..900&family=Delius+Swash+Caps&family=Gabriela&display=swap'
  rel='stylesheet'
/>

<!-- Theme Color -->
<meta name='theme-color' content='#ffffff' media='(prefers-color-scheme: light)' />
<meta name='theme-color' content='#0a0a0a' media='(prefers-color-scheme: dark)' />

<!-- Structured Data (JSON-LD) -->
<script type='application/ld+json' set:html={JSON.stringify(schemaData)} />
